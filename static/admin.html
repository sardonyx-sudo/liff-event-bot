<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社團管理後台</title>
    <!-- Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios (API 請求) -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">
    
    <!-- 標題列 -->
    <div class="bg-green-600 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-lg font-bold">社團管理後台</h1>
        <span v-if="profile" class="text-xs bg-green-700 px-2 py-1 rounded">{{ profile.displayName }}</span>
    </div>

    <!-- 載入中畫面 -->
    <div v-if="loading" class="p-10 text-center text-gray-500">
        載入中...<br><span class="text-xs">正在驗證管理員身分</span>
    </div>

    <!-- 主要內容區 -->
    <div v-else>
        <!-- 頁籤切換 -->
        <div class="flex border-b">
            <button @click="currentTab = 'event'" 
                :class="['flex-1 py-3 text-center font-bold', currentTab === 'event' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500']">
                活動管理
            </button>
            <button @click="currentTab = 'member'" 
                :class="['flex-1 py-3 text-center font-bold', currentTab === 'member' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500']">
                成員管理
            </button>
        </div>

        <!-- 分頁 1: 活動管理 -->
        <div v-if="currentTab === 'event'" class="p-4 space-y-4">
            
            <!-- 編輯/新增表單 -->
            <div class="bg-gray-50 p-4 rounded-lg border">
                <h3 class="font-bold mb-2 text-gray-700">{{ isEditing ? '編輯活動' : '建立新活動' }}</h3>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500">主題 (必填)</label>
                        <input v-model="eventForm.title" type="text" class="w-full p-2 border rounded" placeholder="例：會員大會">
                    </div>
                    
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">日期</label>
                            <input v-model="eventForm.event_date" type="date" class="w-full p-2 border rounded">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">時間</label>
                            <input v-model="eventForm.event_time" type="time" class="w-full p-2 border rounded">
                        </div>
                    </div>

                    <div class="flex space-x-2">
                         <div class="flex-1">
                            <label class="text-xs text-gray-500">類型</label>
                            <select v-model="eventForm.type" class="w-full p-2 border rounded">
                                <option>正式例會</option>
                                <option>聯誼例會</option>
                                <option>分組例會</option>
                                <option>社區服務</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">地點</label>
                            <input v-model="eventForm.location" type="text" class="w-full p-2 border rounded">
                        </div>
                    </div>

                    <!-- 選填欄位摺疊區 -->
                    <details class="text-sm text-gray-600">
                        <summary class="cursor-pointer py-1">更多欄位 (講師/備註)...</summary>
                        <div class="space-y-3 mt-2 pl-2 border-l-2">
                            <input v-model="eventForm.speaker" type="text" class="w-full p-2 border rounded text-sm" placeholder="講師姓名">
                            <input v-model="eventForm.talk_title" type="text" class="w-full p-2 border rounded text-sm" placeholder="演講題目">
                            <textarea v-model="eventForm.description" class="w-full p-2 border rounded text-sm" placeholder="備註事項" rows="2"></textarea>
                        </div>
                    </details>

                    <div class="flex space-x-2 pt-2">
                        <button @click="resetEventForm" class="flex-1 py-2 bg-gray-300 rounded text-gray-700">清空</button>
                        <button @click="submitEvent" class="flex-1 py-2 bg-green-600 text-white rounded font-bold shadow">
                            {{ isEditing ? '更新儲存' : '建立草稿' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- 草稿列表 -->
            <div>
                <h3 class="font-bold mb-2 text-gray-700">草稿列表 (點擊編輯)</h3>
                <div v-if="events.length === 0" class="text-gray-400 text-center py-4">目前沒有草稿</div>
                <div v-for="evt in events" :key="evt.id" 
                    @click="editEvent(evt)"
                    class="bg-white p-3 rounded shadow-sm border-l-4 border-yellow-400 mb-2 cursor-pointer hover:bg-yellow-50">
                    <div class="flex justify-between">
                        <span class="font-bold">{{ evt.event_date }}</span>
                        <span class="text-xs bg-gray-200 px-2 rounded-full">{{ evt.type }}</span>
                    </div>
                    <div class="text-gray-800">{{ evt.title }}</div>
                    <div class="text-xs text-gray-500">{{ evt.location }} {{ evt.event_time }}</div>
                </div>
            </div>
        </div>

        <!-- 分頁 2: 成員管理 -->
        <div v-if="currentTab === 'member'" class="p-4">
            
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">成員排序與狀態</h3>
                <button @click="fetchMembers" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">重新整理</button>
            </div>

            <div class="space-y-2">
                <div v-for="(user, index) in members" :key="user.line_id" class="flex items-center bg-white p-2 rounded border shadow-sm">
                    
                    <!-- 排序控制區 -->
                    <div class="flex flex-col items-center mr-3 space-y-1">
                        <!-- 上箭頭 -->
                        <button @click="swapOrder(index, -1)" :disabled="index === 0" class="text-gray-400 hover:text-green-600 disabled:opacity-0">
                            ▲
                        </button>
                        <!-- 數字輸入 -->
                        <input type="number" v-model.number="user.sort_order" 
                            @blur="updateMember(user)"
                            class="w-10 text-center text-sm border rounded bg-gray-50 focus:bg-white">
                        <!-- 下箭頭 -->
                        <button @click="swapOrder(index, 1)" :disabled="index === members.length - 1" class="text-gray-400 hover:text-green-600 disabled:opacity-0">
                            ▼
                        </button>
                    </div>

                    <!-- 資料區 -->
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-gray-800">{{ user.club_name || user.display_name }}</span>
                            <span v-if="user.club_name" class="text-xs text-gray-400">({{ user.display_name }})</span>
                        </div>
                        <div class="mt-1 flex space-x-2">
                            <!-- 狀態切換按鈕 -->
                            <button @click="toggleStatus(user, 'ACTIVE')" 
                                :class="['text-xs px-2 py-0.5 rounded border', user.status === 'ACTIVE' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-400']">
                                在籍
                            </button>
                            <button @click="toggleStatus(user, 'LEAVE')" 
                                :class="['text-xs px-2 py-0.5 rounded border', user.status === 'LEAVE' ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : 'bg-gray-100 text-gray-400']">
                                請假
                            </button>
                             <button @click="toggleStatus(user, 'INACTIVE')" 
                                :class="['text-xs px-2 py-0.5 rounded border', user.status === 'INACTIVE' ? 'bg-red-100 text-red-700 border-red-300' : 'bg-gray-100 text-gray-400']">
                                離社
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            liffId: 'YOUR_ADMIN_LIFF_ID', // !!! 請在此填入您的 Admin LIFF ID !!!
            loading: true,
            idToken: '',
            profile: null,
            currentTab: 'event', // event | member
            
            // 活動相關
            events: [],
            isEditing: false,
            eventForm: {
                id: null,
                title: '',
                type: '正式例會',
                event_date: '',
                event_time: '19:00',
                location: '例會地點',
                speaker: '',
                talk_title: '',
                description: ''
            },

            // 成員相關
            members: []
        }
    },
    async mounted() {
        await this.initLIFF();
    },
    methods: {
        async initLIFF() {
            try {
                await liff.init({ liffId: this.liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                this.idToken = liff.getIDToken();
                this.profile = await liff.getProfile();
                
                // 初始化完成，讀取資料
                this.loading = false;
                this.fetchEvents();
                this.fetchMembers();

            } catch (err) {
                alert('LIFF 初始化失敗：' + err.message);
                this.loading = false;
            }
        },
        
        // --- API Helper ---
        async api(method, url, data = null) {
            try {
                const config = {
                    method: method,
                    url: url,
                    headers: { 'Authorization': `Bearer ${this.idToken}` },
                    data: data
                };
                const res = await axios(config);
                return res.data;
            } catch (err) {
                console.error(err);
                if (err.response && err.response.status === 403) {
                    alert('權限不足：您不是管理員');
                } else {
                    alert('系統錯誤：' + (err.response?.data?.detail || err.message));
                }
                throw err;
            }
        },

        // --- 活動管理邏輯 ---
        async fetchEvents() {
            const data = await this.api('get', '/api/admin/events');
            this.events = data.events;
        },
        async submitEvent() {
            if (!this.eventForm.title || !this.eventForm.event_date) {
                alert('請填寫完整資訊 (主題、日期)');
                return;
            }

            try {
                if (this.isEditing) {
                    // 修改
                    await this.api('put', `/api/admin/events/${this.eventForm.id}`, this.eventForm);
                    alert('更新成功');
                } else {
                    // 新增
                    await this.api('post', '/api/admin/events', this.eventForm);
                    alert('建立成功');
                }
                this.resetEventForm();
                this.fetchEvents(); // 刷新列表
            } catch (e) {}
        },
        editEvent(evt) {
            // 複製物件避免直接修改列表
            this.eventForm = { ...evt };
            this.isEditing = true;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },
        resetEventForm() {
            this.isEditing = false;
            this.eventForm = {
                id: null,
                title: '',
                type: '正式例會',
                event_date: '',
                event_time: '19:00',
                location: '例會地點',
                speaker: '',
                talk_title: '',
                description: ''
            };
        },

        // --- 成員管理邏輯 ---
        async fetchMembers() {
            const data = await this.api('get', '/api/admin/members');
            this.members = data.members;
        },
        async updateMember(user) {
            // 單筆更新 (例如修改排序數字或狀態)
            try {
                await this.api('put', `/api/admin/members/${user.line_id}`, {
                    sort_order: user.sort_order,
                    status: user.status,
                    club_name: user.club_name
                });
                // 不跳 alert 避免干擾，但可考慮加個 toast
            } catch (e) {}
        },
        async toggleStatus(user, newStatus) {
            if (user.status === newStatus) return;
            user.status = newStatus; // 前端先變
            await this.updateMember(user); // 後端更新
        },
        async swapOrder(index, direction) {
            // direction: -1 (Up), 1 (Down)
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= this.members.length) return;

            // 交換陣列位置
            const temp = this.members[index];
            this.members[index] = this.members[targetIndex];
            this.members[targetIndex] = temp;

            // 交換 sort_order 數值 (邏輯：交換兩者的排序號碼)
            const orderA = this.members[index].sort_order;
            const orderB = this.members[targetIndex].sort_order;
            
            this.members[index].sort_order = orderB;
            this.members[targetIndex].sort_order = orderA;

            // 呼叫 API 更新這兩位 (Promise.all 平行處理)
            await Promise.all([
                this.updateMember(this.members[index]),
                this.updateMember(this.members[targetIndex])
            ]);
        }
    }
}).mount('#app');
</script>
</body>
</html>
